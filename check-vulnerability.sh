#!/bin/bash
#!/bin/bash
# Author: Sushant Chawla
# Description: Script to check vulnerabilities in wordpress site

# Function to fetch vulnerability data from WP Vulnerability API
check_vulnerability() {
  plugin_slug=$1
  installed_version=$2
  api_url="https://www.wpvulnerability.net/plugin/$plugin_slug/"

  # Fetch plugin vulnerability details from API
  response=$(curl -s "$api_url")

  # Validate JSON response
  if ! echo "$response" | jq . > /dev/null 2>&1; then
    echo "Error: Invalid JSON response for $plugin_slug. Skipping..."
    return
  fi

  # Check for error in the response
  error=$(echo "$response" | jq -r '.error')
  if [[ "$error" != "0" ]]; then
    echo "Error: API returned an error for $plugin_slug. Skipping..."
    return
  fi

  # Check if vulnerability data exists
  vulnerabilities=$(echo "$response" | jq -r '.data.vulnerability')
  if [[ "$vulnerabilities" == "null" ]]; then
    # Skip plugins with no vulnerabilities
    return
  fi

  # Process vulnerabilities
  echo "$response" | jq -c '.data.vulnerability[]' | while read -r vulnerability; do
    max_version=$(echo "$vulnerability" | jq -r '.operator.max_version')
    max_operator=$(echo "$vulnerability" | jq -r '.operator.max_operator')

    if [[ -n "$max_version" && -n "$max_operator" ]]; then
      # Correctly evaluate the version comparison
      wp eval "
      if (version_compare('$installed_version', '$max_version', '$max_operator')) {
          exit(1);
      } else {
          exit(0);
      }" > /dev/null 2>&1

      if [[ $? -eq 1 ]]; then
        echo "Vulnerable plugin detected: $plugin_slug ($installed_version). Vulnerable up to $max_operator $max_version."
      fi
    fi
  done
}

# Get the list of installed plugins and their versions
plugins=$(wp plugin list --fields=name,version --format=csv | grep -v hello | grep -v advanced-cache.php | grep -v object-cache.php | grep -v object-cache-pro | tail -n +2)

# Loop through plugins to check vulnerabilities
echo "Checking plugins for vulnerabilities, this may take some time if there are large number of plugins installed on the site..."
while IFS=',' read -r plugin_name plugin_version; do
  check_vulnerability "$plugin_name" "$plugin_version"
done <<< "$plugins"

echo "Vulnerability check complete."
