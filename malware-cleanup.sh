#!/bin/bash

BASE_PATH="/home/master/applications"
echo "üîç Scanning all WordPress themes under: $BASE_PATH/*/public_html/wp-content/themes/"

# Glob all theme directories
for THEME_DIR in $BASE_PATH/*/public_html/wp-content/themes/*; do
    # Only proceed if it's a directory
    if [[ -d "$THEME_DIR" ]]; then

        # Loop over all PHP files in the theme
        for file in "$THEME_DIR"/*.php; do
            [[ -f "$file" ]] || continue  # skip if no .php files

            if grep -q "function wptheme_stat" "$file" && grep -q 'add_action("wp_head", "wptheme_stat' "$file"; then
                echo "‚ö†Ô∏è  Found suspicious block in: $file"

                # Remove malicious block (from comment to add_action line)
                sed -i.bak '/\/\* Theme statistics function \*\//,/add_action("wp_head", "wptheme_stat");/d' "$file"

                echo "‚úÖ Removed malware from: $file (backup: $file.bak)"
            fi
        done
    fi
done

echo "‚úÖ Scan complete across all applications."
